<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CraftersCrypt | OpenAPI Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #6c5ce7; }
        body { background: var(--bg); color: #e0e0e0; font-family: sans-serif; }
        .kv { display: flex; border-bottom: 1px solid #333; padding: 4px 0; font-family: monospace; font-size: 0.85rem; }
        .k { font-weight: bold; color: #888; min-width: 160px; }
        .v { color: #ccc; word-break: break-all; }
        .nested { margin-left: 15px; border-left: 1px solid #444; padding-left: 10px; }
        details summary { cursor: pointer; color: var(--accent); list-style: none; }
        details summary::-webkit-details-marker { display: none; }
        .games-table { width: 100%; border-collapse: collapse; }
        .games-table th { text-align: left; border-bottom: 2px solid #444; padding: 8px; }
        .games-table td { border-bottom: 1px solid #333; padding: 8px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold">Network <span class="text-[#6c5ce7]">Analytics</span></h1>
            <button id="refreshBtn" class="bg-[#6c5ce7] px-4 py-2 rounded font-bold hover:bg-[#5a4dd1] transition">Refresh</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-[#1e1e1e] p-6 rounded-xl border border-[#333]">
                <div class="text-gray-500 text-xs font-bold uppercase">Online</div>
                <div id="activePlayers" class="text-3xl font-mono text-white">—</div>
                <div id="activePlayersSmall" class="text-xs text-gray-500">Max: —</div>
            </div>
            <div class="bg-[#1e1e1e] p-6 rounded-xl border border-[#333]">
                <div class="text-gray-500 text-xs font-bold uppercase">Status</div>
                <div id="networkStatus" class="text-3xl font-mono text-white">—</div>
                <div id="plannedMaintenance" class="text-xs text-red-400"></div>
            </div>
            <div class="bg-[#1e1e1e] p-6 rounded-xl border border-[#333]">
                <div class="text-gray-500 text-xs font-bold uppercase">Required Rank</div>
                <div id="whitelistRank" class="text-xl font-mono text-yellow-500 mt-2">—</div>
            </div>
        </div>

        <div id="detailsContainer" class="bg-[#1e1e1e] p-6 rounded-xl border border-[#333]">
            <div class="animate-pulse text-gray-500">Initializing...</div>
        </div>
    </div>

    <script>
        const PROXY = 'https://corsproxy.io/?';
        const API_PATH = `${PROXY}${encodeURIComponent('https://craftersmc.net/v1/network/status')}`;
        const CACHE_KEY = 'network-status-cache';
        const TTL = 60 * 1000;

        // --- Logic provided by you, updated for CraftersMC Schema ---

        function renderKV(container, obj) {
            container.innerHTML = '';
            for (const [k, v] of Object.entries(obj)) {
                const row = document.createElement('div');
                row.className = 'kv';
                const key = document.createElement('div'); key.className = 'k'; key.textContent = k;
                const val = document.createElement('div'); val.className = 'v';

                if (v === null) { val.textContent = 'null'; }
                else if (typeof v === 'object') {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary'); 
                    summary.textContent = Array.isArray(v) ? `Array(${v.length})` : 'Object';
                    const inner = document.createElement('div'); inner.className = 'nested';
                    if (Array.isArray(v)) {
                        v.forEach((item, i) => {
                            const sub = document.createElement('details');
                            const su = document.createElement('summary'); su.textContent = `Item ${i}`;
                            const ic = document.createElement('div'); ic.className = 'details-content';
                            if (typeof item === 'object') { renderKV(ic, item); } 
                            else { ic.textContent = String(item); }
                            sub.appendChild(su); sub.appendChild(ic); inner.appendChild(sub);
                        });
                    } else { renderKV(inner, v); }
                    details.appendChild(summary); details.appendChild(inner);
                    val.appendChild(details);
                } else { val.textContent = String(v); }
                row.appendChild(key); row.appendChild(val);
                container.appendChild(row);
            }
        }

        // Adapted flattenGames to handle the "modes" object inside GameCount
        function flattenGames(games) {
            const rows = [];
            // Numeric keys found in ServerStatusResponse schemas
            const numericKeys = ['playerCount', 'count', 'value', 'online'];

            function recurse(obj, prefix = '') {
                for (const [k, v] of Object.entries(obj)) {
                    const currentKey = prefix ? `${prefix}.${k}` : k;
                    if (v === null) continue;
                    
                    // Direct number check
                    if (typeof v === 'number') {
                        rows.push({ key: currentKey, label: k, value: v });
                        continue;
                    }
                    
                    if (typeof v === 'object') {
                        // Check if this is a GameCount object containing 'modes'
                        if (k === 'modes' || v.modes) {
                            recurse(v.modes || v, currentKey);
                        } else {
                            let found = null;
                            for (const nk of numericKeys) {
                                if (nk in v && typeof v[nk] === 'number') {
                                    found = v[nk]; break;
                                }
                            }
                            if (found !== null) { rows.push({ key: currentKey, label: k, value: found }); } 
                            else { recurse(v, currentKey); }
                        }
                    }
                }
            }
            recurse(games);
            return rows;
        }

        function buildGamesTable(games) {
            const table = document.createElement('table');
            table.className = 'games-table';
            table.innerHTML = '<thead><tr><th>Server Mode</th><th>Players</th></tr></thead>';
            const tbody = document.createElement('tbody');
            const rows = flattenGames(games);

            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="font-mono text-sm">${r.key.replace('games.', '')}</td><td class="font-bold text-[#6c5ce7]">${r.value}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            return table;
        }

        async function applyData(data) {
            // Fields from ServerStatusResponse
            document.getElementById('activePlayers').textContent = data.playerCount ?? '—';
            document.getElementById('activePlayersSmall').textContent = `Max: ${data.maxPlayerCount ?? '—'}`;
            document.getElementById('networkStatus').textContent = data.fullMaintenance ? 'MAINTENANCE' : 'ONLINE';
            document.getElementById('networkStatus').className = data.fullMaintenance ? 'text-3xl font-mono text-red-500' : 'text-3xl font-mono text-green-400';
            document.getElementById('whitelistRank').textContent = data.whitelistRank ?? 'NONE';

            if (data.plannedMaintenance) {
                document.getElementById('plannedMaintenance').textContent = `Maint: ${data.plannedMaintenance.reason || 'Scheduled'}`;
            }

            const container = document.getElementById('detailsContainer');
            container.innerHTML = '<h2 class="text-lg font-bold mb-4">Distribution</h2>';

            if (data.games) {
                const gamesDetails = document.createElement('details');
                gamesDetails.open = true;
                const summary = document.createElement('summary'); summary.textContent = 'Server List';
                const inner = document.createElement('div');
                inner.appendChild(buildGamesTable(data.games));
                gamesDetails.appendChild(summary); gamesDetails.appendChild(inner);
                container.appendChild(gamesDetails);
            }

            const rawDetails = document.createElement('details');
            rawDetails.className = "mt-6 border-t border-[#333] pt-4";
            const rs = document.createElement('summary'); rs.textContent = 'Full Response Explorer (renderKV)';
            const content = document.createElement('div');
            renderKV(content, data);
            rawDetails.appendChild(rs); rawDetails.appendChild(content);
            container.appendChild(rawDetails);
        }

        // --- Cache and Fetch Wrapper ---

        async function fetchData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true; btn.textContent = '...';
            try {
                const resp = await fetch(API_PATH);
                const data = await resp.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
                applyData(data);
            } catch (e) {
                console.error(e);
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
                if (cached) applyData(cached.data);
            } finally {
                btn.disabled = false; btn.textContent = 'Refresh';
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
            if (cached && (Date.now() - cached.ts < TTL)) applyData(cached.data);
            else fetchData();
            document.getElementById('refreshBtn').onclick = fetchData;
        });
    </script>
</body>
</html>
